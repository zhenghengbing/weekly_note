# zookeeper概述

## zookeeper是什么
  官方说法，Zookeeper分布式服务框架是Apache Hadoop 的一个子项目，它主要是用来解决分布式应用中经常遇到的一些数据管理问题，如：统一命名服务、状态同步服务、集群管理、分布式应用配置项的管理等。以下简称zk
## zookeeper提供了什么
简单的说，zk=文件系统+通知机制
1.文件系统  
  zk维护一个类似文件系统的数据结构，每一个子目录被称作znode，和文件系统一样，可以自由的增加和删除，*唯一不同的地方是*zk的znode可以存储数据。znode可以分为四种类型  
（1）PERSISTENT-持久化目录节点。（客户端与zk断开连接后，该类型节点依然存在）  
（2）PERSISTENT_SEQUENTIAL-持久化顺序目录节点。（客户端与zk断开连接，节点依旧存在，并且zk会给该类型节点明后才能进行顺序编号）  
（3）EPHEMERAL-临时目录节点（客户端与zk断开连接后，该类型节点消失）  
（4）EPHEMERAL_SEQUENTIAL-临时顺序目录编号节点。（客户端与zk断开连接后，该节点被删除，只是zk给该类型节点名称进行顺序编号）  
2.通知机制  
  客户端注册监听它关心的目录节点，当目录节点发生变化（数据改变，删除，子目录节点增删）时，zk会通知客户端  

## zookeeper可以做什么
1.命名服务  
  zk的命名服务，我们常说的服务注册与发现，主要是根据指定名字来获取资源或者服务器的地址，服务提供者等信息，利用去znode节点的特点和watcher机制，将其动态注册和 获取服务信息的配置中心，统一管理服务名称和其对应的服务器列表信息。例如dubbo里将zk作为注册中西使用  
2.配置管理  
  把应用配置放到保存zk的对应节点上，相关的应用程序对这个节点进行进行监听（watcher机制） ，一旦这个节点的信息发生相应的变化，监听这个节点的应用就会收到zk的通知，然后获取新得配置信息。实现配置管理还有很多的方式，比如springcloud的config配置中心，携程的apollo配置中心，当然zk也可以实现这样的功能。  
3.集群管理  
  集群管理无外乎两点，是否有机器加入或退出，选举master。对于机器的加入和退出来说，所有机器在一个指定的父节点下创建临时节点，然后监听这个父节点，一旦有机器挂掉，该机器与zk的链接断开，相应的子节点就会被删除，其他的机器就会收到相应的通知，当有新的机器加入时类似。对于选举mater，以后作为单独的章节进行介绍。  
4.分布式锁  
  有了zk的一致性文件系统，所得问题变得容易。所服务可以分为两类，一个是保持独占，一个是控制时序。  
  对于第一类，我们将zk的一个znode看做一把锁，通过创建节点的方式来实现，所有client都去创建一个节点/lock，最终成功创建了这个/lock节点的客户端被视作拥有了锁，用完之后再删掉/lock节点  
  对于第二类，假设/lock节点已经存在，所有的客户端去该节点下创建临时顺序编号目录子节点，规定编号最小获取锁。  

## zookeeper的一些其他概念
1.watcher  
  watcher机制是zk的一个非常核心的功能，客户端watcher可以监控节点的数据变化以及它的子节点的变化，一旦这些状态发生变化，zk服务端就会通知在这个节点上设置过watcher的客户端，从而每个客户端都很快感知，它所监听的节点发生变化，而做出对应的逻辑处理。  
  znode节点可以设置两类watch，一种是Datawatchs，基于znode节点的数据变化从而触发watch事件，另一种是Childwatchs，基于znode的子节点发生变化从而触发watch事件。  
  **watch对节点的监听事件是一次性的**，客户端在指定的节点设置了watch，一旦该节点数据发生变化通知一次客户端之后，客户端对该节点的监听事件就失效了，如果还要监听这个节点，就需要我们在客户端的监听回调中，再次对该节点的watch事件设置为true，否则客户端只能收到一次该节点的变更通知。  

参考文章：[https://blog.csdn.net/gs80140/article/details/51496925](https://blog.csdn.net/gs80140/article/details/51496925)
